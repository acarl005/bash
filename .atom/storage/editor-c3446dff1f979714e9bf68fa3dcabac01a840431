{"version":1,"windowDimensions":{"x":65,"y":24,"width":1855,"height":1056,"maximized":true},"grammars":{"grammarOverridesByPath":{}},"project":{"deserializer":"Project","paths":["/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api"],"buffers":[{"id":"c7845cd02dcea57d09b468c1b7311599","text":"var express = require('express');\nvar bodyParser = require('body-parser');\nvar mongoose = require('mongoose');\nvar User = require('./models/user');\nvar Job = require('./models/job');\nvar jwt = require('./services/jwt');\n\nvar app = express();\napp.use(bodyParser.json());\napp.use(function(req, res, next) {\n  res.header('Access-Control-Allow-Origin', '*');\n  res.header('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE');\n  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n  next();\n});\n\napp.post('/register', function(req, res) {\n\n  User.findOne({email: req.body.email}, function(err, user) {\n    if (err) throw err;\n    if (user)\n      return res.status(400).send({message: 'Email already registered'});\n\n    user = new User({\n      email: req.body.email,\n      password: req.body.password,\n    });\n\n    user.save(function(err) {\n      createTokenAndSend(user, res);\n    });\n  });\n\n});\n\napp.post('/login', function(req, res) {\n  User.findOne({email: req.body.email}, function(err, user) {\n    if (err) throw err;\n    if (!user)\n      return res.status(401).send({message: 'Invalid email/password'});\n\n    user.comparePassword(req.body.password, function(err, isMatch) {\n      if (err) throw err;\n      if (!isMatch)\n        return res.status(401).send({message: 'Invalid email/password'});\n      createTokenAndSend(user, res);\n    });\n\n  });\n});\n\nfunction createTokenAndSend(user, res) {\n  var payload = {\n    sub: user.id,\n  };\n  var token = jwt.encode(payload, \"shh..\");\n  res.status(200).send({\n    user: user.toJSON(),\n    token: token,\n  });\n}\n\n\napp.get('/jobs', function(req, res) {\n  if (!req.headers.authorization) return res.sendStatus(401);\n  var token = req.headers.authorization.split(' ')[1];\n  var payload = jwt.decode(token, 'shh..');\n  if (!payload.sub)\n    res.status(401).send({message: 'Authentication failed.'});\n\n  Job.find().lean().exec(function (err, jobs) {\n    return res.json(jobs);\n  });\n});\n\nmongoose.connect('mongodb://localhost/token');\n\nvar server = app.listen(3000, function() {\n  console.log('API listening on port', server.address().port);\n});\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"23":{"range":{"start":{"row":28,"column":0},"end":{"row":28,"column":1}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"24":{"range":{"start":{"row":75,"column":0},"end":{"row":76,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"25":{"range":{"start":{"row":79,"column":0},"end":{"row":79,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"26":{"range":{"start":{"row":60,"column":0},"end":{"row":60,"column":1}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"27":{"range":{"start":{"row":51,"column":39},"end":{"row":51,"column":40}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":60,"column":1},"end":{"row":60,"column":1}},"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"4":{"id":"4","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":5,"history":{"version":3,"nextCheckpointId":12,"undoStack":[{"type":"group-start","snapshot":{"2":{"1":{"range":[[75,28],[75,65]],"properties":{"type":"selection","goalScreenRange":null},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[75,28],[75,65]],"newRange":[[75,28],[75,29]],"oldText":"andy:corn@ds041377.mongolab.com:41377","newText":"l"}},{"type":"change","content":{"oldRange":[[75,29],[75,29]],"newRange":[[75,29],[75,30]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[75,30],[75,30]],"newRange":[[75,30],[75,31]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[75,31],[75,31]],"newRange":[[75,31],[75,32]],"oldText":"","newText":"a"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[75,32],[75,32]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[75,32],[75,32]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[75,32],[75,32]],"newRange":[[75,32],[75,33]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[75,33],[75,33]],"newRange":[[75,33],[75,34]],"oldText":"","newText":"h"}},{"type":"change","content":{"oldRange":[[75,34],[75,34]],"newRange":[[75,34],[75,35]],"oldText":"","newText":"o"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[75,35],[75,35]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[75,35],[75,35]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[75,35],[75,35]],"newRange":[[75,35],[75,36]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[75,36],[75,36]],"newRange":[[75,36],[75,37]],"oldText":"","newText":"t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[75,37],[75,37]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[75,37],[75,37]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[81,0],[82,0]],"newRange":[[81,0],[81,0]],"oldText":"\n","newText":""}},{"type":"change","content":{"oldRange":[[80,0],[81,0]],"newRange":[[80,0],[80,0]],"oldText":"\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[75,37],[75,37]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api/api.js","digestWhenLastPersisted":"7bda1f60c935bec9a518cfb05aa4a8df87339040","preferredLineEnding":null,"nextMarkerId":28,"deserializer":"TextBuffer","version":5}]},"workspace":{"deserializer":"Workspace","paneContainer":{"deserializer":"PaneContainer","version":1,"root":{"deserializer":"Pane","id":3,"items":[{"deserializer":"TextEditor","id":4,"softTabs":true,"firstVisibleScreenRow":55,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":5,"softWrapped":false,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api/api.js","bufferId":"c7845cd02dcea57d09b468c1b7311599","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"}],"activeItemURI":"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api/api.js","focused":true,"flexScale":1},"activePaneId":3},"packagesWithActiveGrammars":["language-javascript","language-hyperlink","language-todo"],"destroyedItemURIs":[]},"packageStates":{"pigments":{"project":{"deserializer":"ColorProject","timestamp":"2016-02-10T08:26:14.003Z","version":"1.0.1","markersVersion":"1.0.5","globalSourceNames":["**/*.styl","**/*.stylus","**/*.less","**/*.sass","**/*.scss"],"globalIgnoredNames":["vendor/*","node_modules/*","spec/*","test/*"],"buffers":{"4":{"id":4,"path":"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api/api.js","colorMarkers":[]}},"paths":[],"variables":{"deserializer":"VariablesCollection","content":[]}}},"find-and-replace":{"findOptions":{"findPattern":"conn","replacePattern":"","pathsPattern":"","useRegex":false,"wholeWord":false,"caseSensitive":false,"inCurrentSelection":false},"findHistory":["conn"],"replaceHistory":[],"pathsHistory":[]},"fuzzy-finder":{"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api/api.js":1455092392029},"keybinding-resolver":{},"tabs":[{}],"tree-view":{"directoryExpansionStates":{"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api":{"isExpanded":true,"entries":{"models":{"isExpanded":false,"entries":{}},"node_modules":{"isExpanded":false,"entries":{}},"services":{"isExpanded":false,"entries":{}}}}},"selectedPath":"/home/andy/Documents/codesmith/lectures/unit-11-authentication/auth-tokens-decoupled/api/api.js","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200}},"fullScreen":false}